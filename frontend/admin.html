<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMBAO - Configuration</title>
    <!-- Bootstrap CSS -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/css/bootstrap-icons.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>
        .excel-config-section {
            margin-bottom: 1.5rem;
        }
        
        .excel-table-simulation {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        .pilotes-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        
        .pilote-item {
            padding: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .pilote-item:last-child {
            border-bottom: none;
        }
        
        .editable-lieu[contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: #aaa;
            font-style: italic;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* Am√©liorations visuelles pour le gestionnaire de calendrier */
        .calendar-manager-container .card {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            height: 100%;
        }

        .calendar-manager-container .card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .calendar-manager-container .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
        }

        .exceptions-list-container {
            max-height: 450px; /* Limite la hauteur de la liste */
            overflow-y: auto;   /* Ajoute une barre de d√©filement si n√©cessaire */
            padding-right: 10px; /* Espace pour la barre de d√©filement */
        }

        /* Style de la barre de d√©filement pour les navigateurs Webkit */
        .exceptions-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .exceptions-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .exceptions-list-container::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 10px;
        }
        .exceptions-list-container::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Style pour les groupes d'exceptions */
        .exception-group-row {
            background-color: #f8f9fa;
            font-weight: 500;
            cursor: pointer;
        }
        .exception-group-row:hover {
            background-color: #e9ecef;
        }
        .exception-child-row {
            background-color: #ffffff;
            display: none; /* Cach√© par d√©faut */
        }
        .exception-child-row.expanded {
            display: table-row; /* Affich√© quand le groupe est d√©pli√© */
        }
        .toggle-icon {
            transition: transform 0.2s ease-in-out;
        }
        .expanded .toggle-icon {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-gear-fill me-2"></i>GMBAO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="actions.html">
                            <i class="bi bi-list-task"></i> Actions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="planning.html">
                            <i class="bi bi-calendar-week"></i> Planning
                        </a>
                    </li>
                    <li class="nav-item" id="configMenuItem">
                        <a class="nav-link active" href="admin.html">
                            <i class="bi bi-gear"></i> Configuration
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" 
                           role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="currentUser">Utilisateur</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="authManager.logout()">
                                <i class="bi bi-box-arrow-right"></i> D√©connexion
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Message d'acc√®s refus√© pour les pilotes -->
    <div id="accessDeniedAlert" class="container-fluid py-4" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Acc√®s refus√©</h4>
            <p>Vous n'avez pas les autorisations n√©cessaires pour acc√©der √† cette page.</p>
            <hr>
            <p class="mb-0">Veuillez contacter votre administrateur pour plus d'informations ou retourner au tableau de bord.</p>
            <a href="dashboard.html" class="btn btn-outline-danger mt-3">
                <i class="bi bi-arrow-left me-2"></i>Retourner au tableau de bord
            </a>
        </div>
    </div>

    <!-- Contenu de la page de configuration (masqu√© pour les pilotes) -->
    <div id="configContent" class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">Configuration du Syst√®me</h1>
        </div>
        
        <!-- Configuration Content -->
        <div id="configContainer" class="position-relative">
            <!-- Section Tabs -->
            <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="lieux-tab" data-bs-toggle="tab" 
                            data-bs-target="#lieux" type="button" role="tab">
                        <i class="bi bi-geo-alt"></i> Lieux
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" 
                            data-bs-target="#users" type="button" role="tab">
                        <i class="bi bi-people"></i> Utilisateurs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendriers-tab" data-bs-toggle="tab" 
                            data-bs-target="#calendriers" type="button" role="tab">
                        <i class="bi bi-calendar-week"></i> Calendriers de Travail
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab"
                            data-bs-target="#system" type="button" role="tab">
                        <i class="bi bi-hdd-stack"></i> √âtat du Syst√®me
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                            data-bs-target="#settings" type="button" role="tab">
                        <i class="bi bi-gear"></i> R√©glages
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="compression-tab" data-bs-toggle="tab"
                            data-bs-target="#compression" type="button" role="tab">
                        <i class="bi bi-file-earmark-zip"></i> Compression Images
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="photos-tab" data-bs-toggle="tab" 
                            data-bs-target="#photos" type="button" role="tab">
                        <i class="bi bi-camera"></i> Param√®tres Photos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" href="diagnostic_user.html">
                        <i class="bi bi-person-check-fill"></i> Diagnostic Utilisateur
                    </a>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="configTabsContent">
                <!-- Lieux Tab -->
                <div class="tab-pane fade show active" id="lieux" role="tabpanel">
                    <div class="card excel-config-section">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üìç GESTION DES LIEUX</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Liste des lieux disponibles :</label>
                                <div class="instructions-text small text-muted mb-2">
                                    Instructions :<br>
                                    1. Ajoutez, modifiez ou supprimez des lieux<br>
                                    2. Les modifications seront automatiquement disponibles dans la liste d√©roulante des actions
                                </div>
                            </div>
                            
                            <div class="excel-table-simulation">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 30px; background: #4472C4; color: white;">A</th>
                                            <th>Nom du lieu</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="lieuxTableBody">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Utilisateurs Tab -->
                <div class="tab-pane fade" id="users" role="tabpanel">
                    <div class="card excel-config-section">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üë• GESTION DES COMPTES UTILISATEURS</h5>
                        </div>
                        <div class="card-body">
                            <label class="form-label">Liste des utilisateurs :</label>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Les utilisateurs sont class√©s par r√¥le (Admin, Manager, Pilote, Observateur).
                            </div>
                            <div class="pilotes-list mb-3" id="usersList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            
                            <!-- Formulaire d'ajout de pilote -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Ajouter un nouvel utilisateur</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Explication des r√¥les -->
                                    <div class="alert alert-info mb-3">
                                        <h6><i class="bi bi-info-circle"></i> R√¥les disponibles :</h6>
                                        <ul class="mb-0">
                                            <li><strong>Admin</strong> : Acc√®s complet √† toutes les fonctionnalit√©s (gestion des utilisateurs, configuration, actions)</li>
                                            <li><strong>Manager</strong> : Peut g√©rer les actions et les pilotes, mais pas les param√®tres syst√®me</li>
                                            <li><strong>Pilote</strong> : Peut √™tre assign√© √† des actions et commenter celle-ci</li>
                                            <li><strong>Observateur</strong> : Acc√®s en lecture seule aux actions et au dashboard</li>
                                        </ul>
                                    </div>
                                    
                                    <form id="addPiloteForm" class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nom complet*</label>
                                            <input type="text" class="form-control" id="newPiloteName" placeholder="Nom complet de l'utilisateur" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email*</label>
                                            <input type="email" class="form-control" id="newPiloteEmail" placeholder="Email de l'utilisateur" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Mot de passe*</label>
                                            <input type="password" class="form-control" id="newPilotePassword" placeholder="Mot de passe" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Confirmation du mot de passe*</label>
                                            <input type="password" class="form-control" id="newPilotePasswordConfirm" placeholder="Confirmer le mot de passe" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">R√¥le*</label>
                                            <select class="form-select" id="newUserRole" required>
                                                <option value="pilot" selected>Pilote</option>
                                                <option value="manager">Manager</option>
                                                <option value="observer">Observateur</option>
                                                <option value="admin">Administrateur</option>
                                            </select>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-success" id="addUserButton">
                                                <i class="bi bi-plus"></i> Cr√©er l'utilisateur
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calendriers Tab -->
                <div class="tab-pane fade" id="calendriers" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üìÖ GESTION AVANC√âE DES CALENDRIERS</h5>
                            <div>
                                <select class="form-select form-select-sm" id="calendarUserSelect">
                                    <!-- Sera rempli par le JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="calendarContainer">
                                <!-- Le composant CalendarManager sera charg√© ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Status Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="bi bi-hdd-stack"></i> √âtat du Stockage</h5>
                        </div>
                        <div class="card-body" id="storageInfoContainer">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement des informations de stockage...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-gear"></i> R√©glages du Syst√®me</h5>
                        </div>
                        <div class="card-body">
                            
                            <!-- Tol√©rance de retard -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Vision avec tol√©rance des retards</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-info-circle"></i> Fonctionnement :</h6>
                                        <p class="mb-2">Cette option vous permet de voir <strong>toutes les statistiques</strong> avec une vision tol√©rante des retards.</p>
                                        <ul class="mb-0 small">
                                            <li><strong>D√©sactiv√©</strong> : Affichage standard des retards</li>
                                            <li><strong>Activ√©</strong> : Vous voyez tous les graphiques avec tol√©rance appliqu√©e (bas√©e sur les heures de travail de chaque utilisateur)</li>
                                            <li><strong>üîí Personnel</strong> : Seul VOUS voyez cette vue modifi√©e, les autres utilisateurs gardent l'affichage normal</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="delayToleranceSwitch">
                                                <label class="form-check-label" for="delayToleranceSwitch">
                                                    <strong>Activer ma vision avec tol√©rance</strong>
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                <strong>R√©glage personnel</strong> : Modifie seulement VOTRE vue des graphiques et statistiques
                                            </div>
                                            <div id="toleranceStatus" class="mt-2">
                                                <span class="badge bg-secondary">Chargement...</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button id="applyToleranceBtn" class="btn btn-success" disabled>
                                                <i class="bi bi-save"></i> Sauvegarder
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="toleranceResults" class="mt-3" style="display: none;">
                                        <div class="alert alert-success">
                                            <h6><i class="bi bi-check-circle"></i> Pr√©f√©rences sauvegard√©es</h6>
                                            <div id="toleranceResultsContent"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Autres r√©glages futurs -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Autres r√©glages</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">D'autres options de configuration seront ajout√©es ici selon les besoins.</p>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Image Compression Tab -->
                <div class="tab-pane fade" id="compression" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-zip"></i> Outil de Compression des Images</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <strong>Attention:</strong> La compression est une op√©ration destructive qui remplace les images originales. Il est fortement recommand√© de faire une sauvegarde compl√®te du dossier <code>backend/uploads</code> avant de proc√©der.
                            </div>

                            <h6 class="card-title">√âtape 1: Pr√©visualiser la compression</h6>
                            <p>S√©lectionnez une image d'exemple pour pr√©visualiser l'effet de la compression √† diff√©rentes qualit√©s.</p>
                            
                            <div class="mb-3">
                                <label for="image-preview-select" class="form-label">Choisir une image d'exemple:</label>
                                <select class="form-select" id="image-preview-select">
                                    <option value="">Chargement des images...</option>
                                </select>
                            </div>

                            <div id="preview-area" class="mt-3" style="display: none;">
                                <div class="mb-3">
                                    <label for="quality-slider" class="form-label">Qualit√© de compression: <strong id="quality-value">75</strong></label>
                                    <input type="range" class="form-range" min="10" max="95" step="5" value="75" id="quality-slider">
                                </div>
                                <div class="row text-center">
                                    <div class="col-md-6">
                                        <h6>Originale</h6>
                                        <img id="original-preview" src="" alt="Aper√ßu original" class="img-fluid rounded border">
                                        <p class="mt-2">Taille: <strong id="original-size"></strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Compress√©e</h6>
                                        <img id="compressed-preview" src="" alt="Aper√ßu compress√©" class="img-fluid rounded border">
                                        <p class="mt-2">Taille: <strong id="compressed-size"></strong></p>
                                        <p class="mt-1">√âconomie: <strong id="space-saving"></strong></p>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h6 class="card-title">√âtape 2: Appliquer la compression √† toutes les images</h6>
                            <p>Cette action va compresser <strong>toutes les images (JPG/PNG)</strong> du dossier <code>uploads/photos</code> avec la qualit√© s√©lectionn√©e ci-dessus.</p>
                            <button id="compress-all-btn" class="btn btn-danger" disabled>
                                <i class="bi bi-exclamation-triangle-fill"></i> Lancer la compression globale
                            </button>
                        </div>
                        <div class="card-footer" id="compression-results" style="display: none;">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Photos Tab -->
                <div class="tab-pane fade" id="photos" role="tabpanel">
                    <div class="card excel-config-section">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üì∑ PARAM√àTRES DES PHOTOS</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <label class="col-sm-4 col-form-label">Dossier des photos:</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="photosFolder" 
                                               placeholder="C:\Chemin\Vers\Photos ou uploads/photos">
                                        <button class="btn btn-outline-secondary" onclick="configManager.selectPhotosFolder()">
                                            Parcourir...
                                        </button>
                                    </div>
                                    <div class="form-text text-muted small">
                                        Vous pouvez utiliser un chemin Windows complet (C:\Dossier\Photos) ou un chemin relatif (uploads/photos)
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-8 offset-sm-4">
                                    <button class="btn btn-outline-info" onclick="configManager.refreshPhotos()">
                                        Rafra√Æchir les photos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Buttons -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <div class="btn-group mb-4">
                        <button class="btn btn-success btn-lg" onclick="configManager.saveConfiguration()">
                            <i class="bi bi-check-circle"></i> Sauvegarder la Configuration
                        </button>
                    </div>
                    
                    <!-- Data Reset Button -->
                    <div class="mt-4">
                        <button class="btn btn-danger btn-lg" id="resetAppDataBtn">
                            <i class="bi bi-exclamation-triangle"></i> R√©initialiser toutes les donn√©es de l'application
                        </button>
                        <div class="text-muted mt-2">
                            <small>Cette action supprimera toutes les actions, exceptions de calendrier et horaires de travail, mais pr√©servera les utilisateurs et mots de passe.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <!-- Modal pour r√©initialiser le mot de passe -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="resetPasswordModalLabel">
                        <i class="bi bi-key"></i> R√©initialiser le mot de passe
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Vous √™tes sur le point de r√©initialiser le mot de passe de <strong id="resetPasswordUserName"></strong>.
                    </p>
                    <form id="resetPasswordForm">
                        <input type="hidden" id="resetPasswordUserId">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Nouveau mot de passe</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Confirmer le mot de passe</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-warning" id="resetPasswordButton" onclick="configManager.resetUserPassword()">
                        <i class="bi bi-key"></i> R√©initialiser le mot de passe
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap and application scripts -->
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js?v=20250612_0832_USERS"></script>
    <script src="js/utils/userManager.js?v=20250612_0832"></script>
    <script src="js/components/ConfigManager.v2.js?v=20250612_0832_USERS"></script>
    <script src="js/components/CalendarManager.js?v=20250603_FINAL_FIX2"></script>
    
    <script>
        // V√©rifier le r√¥le de l'utilisateur et contr√¥ler l'acc√®s √† la page
        document.addEventListener('DOMContentLoaded', function() {
            const userRole = authManager.getUserRole();
            const configMenuItem = document.getElementById('configMenuItem');
            const accessDeniedAlert = document.getElementById('accessDeniedAlert');
            const configContent = document.getElementById('configContent');
            
            // Si l'utilisateur est un pilote, masquer l'√©l√©ment de configuration et le contenu
            if (userRole === 'pilot') {
                if (configMenuItem) {
                    configMenuItem.style.display = 'none';
                }
                
                if (accessDeniedAlert && configContent) {
                    accessDeniedAlert.style.display = 'block';
                    configContent.style.display = 'none';
                    console.log('[GMAO] Acc√®s √† la configuration refus√© pour les pilotes');
                }
            }
        });
        
        // Fonction de r√©initialisation des donn√©es de l'application
        async function resetApplicationData() {
            // Confirmation avec un double check pour √©viter les accidents
            if (!confirm('ATTENTION: Cette action va supprimer TOUTES les donn√©es de l\'application, y compris toutes les actions, exceptions de calendrier et horaires de travail.\n\nLes utilisateurs et mots de passe seront conserv√©s.\n\nVoulez-vous continuer ?')) {
                return;
            }
            
            // Deuxi√®me confirmation
            if (!confirm('CONFIRMATION FINALE: √ätes-vous vraiment s√ªr de vouloir r√©initialiser toutes les donn√©es ?\n\nCette action est irr√©versible.')) {
                return;
            }
            
            try {
                showLoading();
                
                // Appel √† l'endpoint API
                const apiService = new ApiService();
                const response = await apiService.request('/config/reset-application-data', {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                
                if (response && response.message) {
                    showToast(response.message, 'success');
                    
                    // Recharger la page pour r√©fl√©ter les changements
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            } catch (error) {
                console.error('Erreur lors de la r√©initialisation des donn√©es:', error);
                showToast('Erreur lors de la r√©initialisation des donn√©es. V√©rifiez la console pour plus de d√©tails.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Fonction pour afficher l'indicateur de chargement
        function showLoading() {
            let loadingOverlay = document.querySelector('.loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
            }
            loadingOverlay.style.display = 'flex';
        }
        
        // Fonction pour masquer l'indicateur de chargement
        function hideLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // Initialize config manager and calendar manager
        document.addEventListener('DOMContentLoaded', async () => {
            // Function to fetch and display storage info
            const loadStorageInfo = async () => {
                const container = document.getElementById('storageInfoContainer');
                try {
                    const api = new ApiService();
                    const data = await api.request('/admin/storage-info');

                    const formatBytes = (bytes, decimals = 2) => {
                        if (bytes === 0) return '0 Octets';
                        const k = 1024;
                        const dm = decimals < 0 ? 0 : decimals;
                        const sizes = ['Octets', 'Ko', 'Mo', 'Go', 'To', 'Po'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                    };

                    const totalFormatted = formatBytes(data.total_disk_space);
                    const usedFormatted = formatBytes(data.used_disk_space);
                    const freeFormatted = formatBytes(data.free_disk_space);
                    const uploadsFormatted = formatBytes(data.uploads_folder_size);
                    const usedPercentage = ((data.used_disk_space / data.total_disk_space) * 100).toFixed(2);

                    container.innerHTML = `
                        <h6 class="card-title">Utilisation du Disque</h6>
                        <p>Espace total: <strong>${totalFormatted}</strong></p>
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${usedPercentage}%;" 
                                 aria-valuenow="${usedPercentage}" aria-valuemin="0" aria-valuemax="100">
                                ${usedFormatted} utilis√©s (${usedPercentage}%)
                            </div>
                        </div>
                        <p>Espace disponible: <strong class="text-success">${freeFormatted}</strong></p>
                        <hr>
                        <h6 class="card-title mt-4">Taille du Dossier des Photos</h6>
                        <p>Taille totale des images: <strong>${uploadsFormatted}</strong></p>
                        <p>Pourcentage de l'espace disque total: <strong>${data.uploads_percentage_of_disk}%</strong></p>
                    `;
                } catch (error) {
                    container.innerHTML = `<div class="alert alert-danger">Erreur lors du chargement des informations de stockage: ${error.message}</div>`;
                }
            };

            // Image Compression Logic
            const initImageCompression = () => {
                const imageSelect = document.getElementById('image-preview-select');
                const previewArea = document.getElementById('preview-area');
                const qualitySlider = document.getElementById('quality-slider');
                const qualityValue = document.getElementById('quality-value');
                const originalPreview = document.getElementById('original-preview');
                const originalSize = document.getElementById('original-size');
                const compressedPreview = document.getElementById('compressed-preview');
                const compressedSize = document.getElementById('compressed-size');
                const spaceSaving = document.getElementById('space-saving');
                const compressAllBtn = document.getElementById('compress-all-btn');
                const resultsContainer = document.getElementById('compression-results');
                
                let selectedFilePath = null;
                const api = new ApiService();

                const formatBytes = (bytes, decimals = 2) => {
                    if (!bytes || bytes === 0) return '0 Octets';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Octets', 'Ko', 'Mo', 'Go', 'To', 'Po'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                };

                const updatePreview = async () => {
                    if (!selectedFilePath) return;

                    const quality = qualitySlider.value;
                    qualityValue.textContent = quality;
                    compressedPreview.src = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";

                    try {
                        const data = await api.request('/admin/compress-preview', {
                            method: 'POST',
                            body: JSON.stringify({ file_path: selectedFilePath, quality: parseInt(quality) })
                        });
                        
                        // Use the original size sent directly by the API
                        originalSize.textContent = formatBytes(data.original_size);
                        
                        compressedPreview.src = data.compressed_image_data_url;
                        compressedSize.textContent = formatBytes(data.compressed_size);
                        
                        const saving = data.original_size - data.compressed_size;
                        const savingPercent = data.original_size > 0 ? ((saving / data.original_size) * 100).toFixed(1) : 0;
                        spaceSaving.textContent = `${formatBytes(saving)} (${savingPercent}%)`;

                    } catch (error) {
                        showToast(`Erreur de pr√©visualisation: ${error.message}`, 'error');
                        compressedPreview.src = '';
                    }
                };

                const loadSampleImages = async () => {
                    try {
                        const imagePaths = await api.request('/admin/sample-images');
                        imageSelect.innerHTML = '<option value="">-- S√©lectionnez une image --</option>';
                        if (imagePaths.length === 0) {
                            imageSelect.innerHTML = '<option value="">Aucune image trouv√©e</option>';
                            imageSelect.disabled = true;
                            return;
                        }
                        imagePaths.forEach(path => {
                            const option = document.createElement('option');
                            option.value = path;
                            option.textContent = path.split('/').pop();
                            imageSelect.appendChild(option);
                        });
                    } catch (error) {
                        showToast('Erreur de chargement des images d\'exemple.', 'error');
                    }
                };

                imageSelect.addEventListener('change', (event) => {
                    selectedFilePath = event.target.value;
                    if (selectedFilePath) {
                        // Build the absolute URL to the backend's media serving endpoint
                        originalPreview.src = `${api.baseURL}/photos/media/${selectedFilePath}`;
                        previewArea.style.display = 'block';
                        compressAllBtn.disabled = false;
                        updatePreview();
                    } else {
                        previewArea.style.display = 'none';
                        compressAllBtn.disabled = true;
                    }
                });

                qualitySlider.addEventListener('input', () => { qualityValue.textContent = qualitySlider.value; });
                qualitySlider.addEventListener('change', updatePreview);

                compressAllBtn.addEventListener('click', async () => {
                    const quality = qualitySlider.value;
                    if (!confirm(`Vous √™tes sur le point de compresser TOUTES les images avec une qualit√© de ${quality}. Cette action est IRR√âVERSIBLE. Continuer ?`)) {
                        return;
                    }
                    compressAllBtn.disabled = true;
                    compressAllBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Compression en cours...';
                    resultsContainer.style.display = 'block';
                    resultsContainer.innerHTML = '<div class="text-center">Traitement en cours, veuillez patienter...</div>';
                    
                    try {
                        const data = await api.request('/admin/compress-all-images', {
                            method: 'POST',
                            body: JSON.stringify({ quality: parseInt(quality) })
                        });
                        let resultHTML = `<p><strong>Op√©ration termin√©e !</strong></p><ul>
                                <li>Fichiers trait√©s: ${data.processed_files}</li>
                                <li>Taille totale avant: ${formatBytes(data.total_size_before)}</li>
                                <li>Taille totale apr√®s: ${formatBytes(data.total_size_after)}</li>
                                <li class="text-success"><strong>Espace √©conomis√©: ${formatBytes(data.space_saved)}</strong></li></ul>`;
                        if (data.errors && data.errors.length > 0) {
                            resultHTML += `<p class="text-danger"><strong>Erreurs:</strong></p><ul>${data.errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
                        }
                        resultsContainer.innerHTML = resultHTML;
                    } catch (error) {
                        resultsContainer.innerHTML = `<p class="text-danger"><strong>Erreur:</strong> ${error.message}</p>`;
                    } finally {
                        compressAllBtn.disabled = false;
                        compressAllBtn.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Lancer la compression globale';
                    }
                });

                // Load initial data
                loadSampleImages();
            };

            // Load storage info when the system tab is shown
            const systemTab = document.querySelector('#system-tab');
            if (systemTab) {
                systemTab.addEventListener('shown.bs.tab', loadStorageInfo);
                if (systemTab.classList.contains('active')) {
                    loadStorageInfo();
                }
            }
            
            // Initialize image compression tab logic
            initImageCompression();

            // Restaurer l'onglet actuel apr√®s rechargement
            const savedActiveTab = localStorage.getItem('calendarActiveTab');
            if (savedActiveTab) {
                console.log('[ADMIN] Restauration de l\'onglet:', savedActiveTab);
                const tabEl = document.querySelector(`button[data-bs-target="${savedActiveTab}"]`);
                if (tabEl) {
                    const tab = new bootstrap.Tab(tabEl);
                    tab.show();
                }
            }
            
            // V√©rifier le r√¥le de l'utilisateur et appliquer les restrictions d'acc√®s
            try {
                const userRole = await authManager.getUserRole();
                
                // Restrictions pour les pilotes et observateurs
                if (userRole === 'pilot' || userRole === 'observer') {
                    // Masquer le contenu de configuration pour les pilotes et observateurs
                    document.getElementById('configContent').innerHTML = `
                        <div class="alert alert-danger">
                            <h4><i class="bi bi-exclamation-triangle-fill"></i> Acc√®s restreint</h4>
                            <p>En tant que ${userRole === 'pilot' ? 'pilote' : 'observateur'}, vous n'avez pas acc√®s √† la section de configuration.</p>
                            <a href="dashboard.html" class="btn btn-primary">Retourner au tableau de bord</a>
                        </div>
                    `;
                }
                
                // Restrictions pour les managers
                if (userRole === 'manager') {
                    // Masquer l'onglet Utilisateurs
                    const usersTab = document.querySelector('#users-tab');
                    if (usersTab) {
                        usersTab.closest('li').style.display = 'none';
                    }
                    
                    // Masquer l'onglet Param√®tres Photos
                    const photosTab = document.querySelector('#photos-tab');
                    if (photosTab) {
                        photosTab.closest('li').style.display = 'none';
                    }
                    
                    // Si l'onglet actif est l'un des onglets masqu√©s, rediriger vers l'onglet Lieux
                    const activeTabId = document.querySelector('.tab-pane.active')?.id;
                    if (activeTabId === 'users' || activeTabId === 'photos') {
                        const tab = new bootstrap.Tab(document.querySelector('#lieux-tab'));
                        tab.show();
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification du r√¥le utilisateur:', error);
            }
                
                // D√©sactiver tous les onglets
                document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active', 'show');
                });
                
                // Activer l'onglet sauvegard√©
                const tabToActivate = document.getElementById(savedActiveTab);
                if (tabToActivate) {
                    tabToActivate.classList.add('active');
                    const targetPaneId = tabToActivate.getAttribute('data-bs-target');
                    if (targetPaneId) {
                        const paneToActivate = document.querySelector(targetPaneId);
                        if (paneToActivate) {
                            paneToActivate.classList.add('active', 'show');
                        }
                    }
                }
                
                // Nettoyer le localStorage
                localStorage.removeItem('calendarActiveTab');
            
            // Initialize config manager
            window.configManager = new ConfigManager();
            await configManager.init();
            
            try {
                // Utiliser le gestionnaire d'utilisateurs centralis√©
                const userSelect = document.getElementById('calendarUserSelect');
                if (userSelect) {
                    // Remplir le s√©lecteur avec les utilisateurs de mani√®re coh√©rente
                    await window.userManager.populateUserSelect(userSelect, false, "Non assign√©", null, true);
                    
                    // Initialiser le gestionnaire de calendrier avec le premier utilisateur
                    if (userSelect.options.length > 0) {
                        const firstUserId = userSelect.options[0].value;
                        
                        // V√©rifier que l'ID est valide avant d'initialiser
                        if (firstUserId && !isNaN(parseInt(firstUserId))) {
                            // Cr√©er une instance globale propre du gestionnaire de calendrier
                            console.log('[ADMIN] Cr√©ation d\'une instance CalendarManager propre pour utilisateur', firstUserId);
                            window.calendarManagerInstance = new CalendarManager(new ApiService());
                            await window.calendarManagerInstance.init('calendarContainer', parseInt(firstUserId));
                        
                            // G√©rer le changement d'utilisateur avec validation de l'ID
                            userSelect.addEventListener('change', async (e) => {
                                const selectedUserId = e.target.value;
                                
                                // Valider l'ID avant de l'utiliser
                                if (selectedUserId && !isNaN(parseInt(selectedUserId))) {
                                    // D√âTRUIRE compl√®tement l'instance pr√©c√©dente avant d'en cr√©er une nouvelle
                                    if (window.calendarManagerInstance) {
                                        console.log('[ADMIN] Destruction compl√®te de l\'instance CalendarManager pr√©c√©dente');
                                        try {
                                            window.calendarManagerInstance.destroy();
                                        } catch (error) {
                                            console.warn('[ADMIN] Erreur lors de la destruction:', error);
                                        }
                                        window.calendarManagerInstance = null;
                                    }
                                    
                                    // Cr√©er une NOUVELLE instance compl√®tement propre
                                    console.log('[ADMIN] Cr√©ation d\'une nouvelle instance CalendarManager pour utilisateur', selectedUserId);
                                    window.calendarManagerInstance = new CalendarManager(new ApiService());
                                    await window.calendarManagerInstance.init('calendarContainer', parseInt(selectedUserId));
                                } else {
                                    console.error('ID utilisateur invalide s√©lectionn√©:', selectedUserId);
                                    // Afficher un message d'erreur √† l'utilisateur
                                    document.getElementById('calendarContainer').innerHTML = 
                                        '<div class="alert alert-danger">Erreur: ID utilisateur invalide s√©lectionn√©.</div>';
                                }
                            });
                        } else {
                            console.error('ID du premier utilisateur invalide:', firstUserId);
                            document.getElementById('calendarContainer').innerHTML = 
                                '<div class="alert alert-danger">Erreur: Impossible de charger le calendrier avec l\'ID utilisateur fourni.</div>';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Erreur lors du chargement des utilisateurs', 'error');
            }
            
            // Ajouter un √©couteur d'√©v√©nement pour le bouton de r√©initialisation
            document.getElementById('resetAppDataBtn').addEventListener('click', resetApplicationData);
            
            // Initialiser la gestion de la tol√©rance des retards (stockage local)
            initDelayToleranceManagement();
        });

        // Gestion de la tol√©rance des retards (stockage local)
        async function initDelayToleranceManagement() {
            const toleranceSwitch = document.getElementById('delayToleranceSwitch');
            const applyBtn = document.getElementById('applyToleranceBtn');
            const statusElement = document.getElementById('toleranceStatus');
            const resultsElement = document.getElementById('toleranceResults');
            const resultsContent = document.getElementById('toleranceResultsContent');
            
            // Charger le statut depuis le localStorage
            loadToleranceStatus();
            
            // √âv√©nement pour le switch
            toleranceSwitch.addEventListener('change', function() {
                applyBtn.disabled = false;
                updateStatusDisplay();
            });
            
            // √âv√©nement pour le bouton appliquer
            applyBtn.addEventListener('click', async function() {
                await saveToleranceSettings();
            });
            
            function loadToleranceStatus() {
                try {
                    // Charger depuis le localStorage (r√©glage personnel)
                    const savedSetting = localStorage.getItem('gmao_delay_tolerance_enabled');
                    toleranceSwitch.checked = savedSetting === 'true';
                    updateStatusDisplay();
                } catch (error) {
                    console.error('Erreur lors du chargement du statut:', error);
                    statusElement.innerHTML = '<span class="badge bg-danger">Erreur de chargement</span>';
                }
            }
            
            function updateStatusDisplay() {
                if (toleranceSwitch.checked) {
                    statusElement.innerHTML = '<span class="badge bg-success">Vision avec tol√©rance activ√©e</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-secondary">Vision standard</span>';
                }
            }
            
            async function saveToleranceSettings() {
                applyBtn.disabled = true;
                applyBtn.innerHTML = '<i class="bi bi-save spinner-border spinner-border-sm"></i> Sauvegarde...';
                resultsElement.style.display = 'none';
                
                try {
                    // Sauvegarder dans le localStorage
                    localStorage.setItem('gmao_delay_tolerance_enabled', toleranceSwitch.checked.toString());
                    
                    // Afficher le r√©sultat
                    resultsContent.innerHTML = `
                        <p><strong>Pr√©f√©rences sauvegard√©es avec succ√®s !</strong></p>
                        <p>Votre vision avec tol√©rance est maintenant <strong>${toleranceSwitch.checked ? 'activ√©e' : 'd√©sactiv√©e'}</strong>.</p>
                        <p class="small text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Seul vous verrez cette vue modifi√©e. Les autres utilisateurs gardent l'affichage standard.
                        </p>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" onclick="refreshDashboardNow()">
                                <i class="bi bi-arrow-clockwise"></i> Actualiser le dashboard maintenant
                            </button>
                            <p class="small text-muted mt-2">
                                Ou rechargez manuellement la page du dashboard pour voir les changements.
                            </p>
                        </div>
                    `;
                    resultsElement.style.display = 'block';
                    
                    showToast('Pr√©f√©rences sauvegard√©es avec succ√®s', 'success');
                    updateStatusDisplay();
                    
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    showToast('Erreur lors de la sauvegarde des pr√©f√©rences', 'error');
                } finally {
                    applyBtn.disabled = false;
                    applyBtn.innerHTML = '<i class="bi bi-save"></i> Sauvegarder';
                }
            }
        }
    </script>
    
    <script>
        // Fonction pour rafra√Æchir le dashboard depuis l'admin
        function refreshDashboardNow() {
            if (typeof window.refreshDashboardWithTolerance === 'function') {
                window.refreshDashboardWithTolerance();
                showToast('Dashboard actualis√© avec vos nouvelles pr√©f√©rences', 'success');
            } else {
                // Fallback: ouvrir le dashboard dans un nouvel onglet
                window.open('dashboard.html', '_blank');
                showToast('Dashboard ouvert dans un nouvel onglet', 'info');
            }
        }
    </script>
</body>
</html>
